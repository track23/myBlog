<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><title>解决valine-admin云引擎唤醒失败 | 宅日记</title><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><meta content="telephone=no" name="format-detection"><meta content="on" http-equiv="x-dns-prefetch-control"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="解决valine-admin云引擎自动唤醒唤醒失败"><meta property="og:type" content="article"><meta property="og:title" content="解决valine-admin云引擎唤醒失败"><meta property="og:url" content="https://crosschannel.cc/daily/valine-admin-autoAwaken.html"><meta property="og:site_name" content="宅日记"><meta property="og:description" content="解决valine-admin云引擎自动唤醒唤醒失败"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-05-15T09:23:00.000Z"><meta property="article:modified_time" content="2021-01-01T07:40:46.356Z"><meta property="article:author" content="某个不知名的肥宅"><meta property="article:tag" content="Hexo"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://crosschannel.cc/daily/valine-admin-autoAwaken.html"><link crossorigin="" href="https://cdn.jsdelivr.net" rel="preconnect"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/other.css" media="print" onload='this.media="all",this.onload=null'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload='this.media="all",this.onload=null'><link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"><link rel="shortcut icon" type="image/ico" href="/favicon.ico"><script src="/js/main.js" defer="defer"></script><script>"dark"===localStorage.getItem("theme")?document.documentElement.setAttribute("data-theme","dark"):21<=(new Date).getHours()||(new Date).getHours()<7?document.documentElement.setAttribute("data-theme","dark"):matchMedia("(prefers-color-scheme: dark)").matches&&document.documentElement.setAttribute("data-theme","dark")</script><meta name="generator" content="Hexo 5.2.0"></head><body><div class="loading-bar"><div class="progress"></div></div><div id="sidebar"><header id="site-head"><h1 class="site-title"> <a href="/">宅日记</a></h1><p class="site-description">一个不知名懒肥宅的自留地</p> <button class="iconfont iconcaidan" id="secondary-toggle"></button></header><div id="secondary" aria-expanded="false"><nav id="memu"> <a href="/categories/gal/" class="menu-item">galgame</a> <a href="/categories/%E5%8A%A8%E7%94%BB/" class="menu-item">动画</a> <a href="/categories/%E6%97%A5%E5%B8%B8/" class="menu-item">日常</a> <a href="/aboutme.html" class="menu-item">关于</a> <a href="/links.html" class="menu-item">友链</a></nav><meting-js class="meting" id="2382854733" server="netease" type="playlist" order="random" volume="0.3" preload="none" list-max-height="200px" list-folded="true" lrc-type="false" theme="#00b9f1"></meting-js><form id="search-form" method="GET" action="/search.html" autocomplete="off"> <input id="search-input" type="search" placeholder="search..." name="s" value=""></form><aside id="tagcloud"><h3 class="widget-title">标签云</h3> <a href="/tags/Hexo/" style="font-size:2.2rem">Hexo</a> <a href="/tags/%E4%BA%BA%E7%B1%BB%E5%9C%A3%E7%BB%8F/" style="font-size:.9rem">人类圣经</a> <a href="/tags/%E5%85%A8%E5%B9%B4%E9%BE%84/" style="font-size:2.01rem">全年龄</a> <a href="/tags/%E5%9E%8B%E6%9C%88/" style="font-size:.9rem">型月</a> <a href="/tags/%E5%A5%88%E9%A1%BB%E8%98%91%E8%8F%87/" style="font-size:.9rem">奈须蘑菇</a> <a href="/tags/%E6%B2%BB%E6%84%88/" style="font-size:1.09rem">治愈</a> <a href="/tags/%E6%BF%91%E6%88%B7%E5%8F%A3%E5%BB%89%E4%B9%9F/" style="font-size:1.64rem">濑户口廉也</a> <a href="/tags/%E7%94%B0%E4%B8%AD%E7%BD%97%E5%AF%86%E6%AC%A7/" style="font-size:1.83rem">田中罗密欧</a> <a href="/tags/%E7%A5%9E%E4%BD%9C/" style="font-size:1.46rem">神作</a> <a href="/tags/%E7%BE%BD%E6%B5%B7%E9%87%8E%E5%8D%83%E8%8A%B1/" style="font-size:1.27rem">羽海野千花</a> <a href="/tags/%E8%87%B4%E9%83%81/" style="font-size:1.64rem">致郁</a> <a href="/tags/%E9%83%BD%E5%90%88%E4%B8%BB%E4%B9%89/" style="font-size:.9rem">都合主义</a></aside><a id="friend-link" href="/" rel="noopener external noreferrer" target="_blank" style="display:none"><span id="friend-name"></span> -<span id="friend-desc"></span></a></div></div><main id="main" class="site-main"><article class="posts"><header class="posts-header"><h2 class="posts-title"> <a class="post-title-link" href="/daily/valine-admin-autoAwaken.html">解决valine-admin云引擎唤醒失败</a></h2></header><div class="posts-content"><p>4月就收到了leancloud要限制白嫖用户定时任务的邮件。一直没有太在意。昨天晚上打开leanclou的日志，云引擎已经休眠好几天了。</p><a id="more"></a><blockquote><p>因流控原因，通过定时任务唤醒体验版实例失败，建议升级至标准版云引擎实例避免休眠</p></blockquote><p>使用云引擎自带定时任务以前都是大佬使用vps定时访问云引擎避免自动休眠，但是我没有vps，也找不到大佬，只能从js下手了。</p><p>能唤醒云引擎的方法除了发请求还有就是有人写评论（这条评论不会收到邮件提醒）。唤醒过一次之后，云引擎的定时任务能正常执行。</p><p>除了js发请求唤醒，我还看到有使用github action来唤醒的，这种方法挺好的（我之前没想到）推荐大家使用。</p><p><strong>推荐一个新方法，使用waline</strong>，<a target="_blank" rel="noopener external nofollow noreferrer" href="https://waline.js.org">项目官网</a>，不使用云引擎就不用担心休眠问题。</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.antmoe.com/posts/ff6aef7b/index.html">使用github action解决流控问题</a></p><h2 id="ajax请求唤醒"><a href="#ajax请求唤醒" class="headerlink" title="ajax请求唤醒"></a>ajax请求唤醒</h2><p>思路就是北京时间8点到晚上23点只要有人访问博客就会触发js发ajax请求唤醒云引擎。由于云引擎睡眠的时候发请求不一定会成功（但是有请求就会醒）所有没有做请求失败处理。请求发送后设置cookie避免20分钟内刷新等操作重复发请求。</p><p>虽然博客使用了jQuery，但是我选择fetch，兼容性也凑合（不行就算了）。迟早要把jQuery从博客去掉。</p><p>只认北京时间，避免半夜其他时区打开而唤醒云引擎。北京时间的api是苏宁的。</p><p>cookie中的engine,默认是’0’ ，’1’代表发送过请求。cookie过期时间20分钟，避免刷新等操作重复发请求。</p><p>以下代码没有注释是因为写了注释就导致valine初始化失败。不知道原因QAQ</p><pre><code class="hljs js"><span class="hljs-keyword">var</span> engine = <span class="hljs-built_in">document</span>.cookie.replace(<span class="hljs-regexp">/(?:(?:^|.*;\s*)engine\s*\=\s*([^;]*).*$)|^.*$/</span>, <span class="hljs-string">&quot;$1&quot;</span>) || <span class="hljs-string">&#x27;0&#x27;</span>;
<span class="hljs-keyword">if</span>(engine!=<span class="hljs-string">&#x27;1&#x27;</span>) &#123;
  fetch(<span class="hljs-string">&#x27;https://quan.suning.com/getSysTime.do&#x27;</span>)
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>&#123;
    <span class="hljs-keyword">return</span> response.json();
  &#125;)
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">date</span>) </span>&#123;
    <span class="hljs-keyword">var</span> hours = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(date.sysTime2).getHours();
    <span class="hljs-keyword">if</span>(hours&gt;<span class="hljs-number">7</span> &amp;&amp; hours&lt;<span class="hljs-number">23</span>)&#123;
      fetch(<span class="hljs-string">&#x27;https://你云引擎的地址&#x27;</span>);
      <span class="hljs-keyword">var</span> exp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(date.sysTime2);
      exp.setTime(exp.getTime() + <span class="hljs-number">20</span>*<span class="hljs-number">60</span>*<span class="hljs-number">1000</span>);
      <span class="hljs-built_in">document</span>.cookie = <span class="hljs-string">&quot;engine=1;path=/;expires=&quot;</span>+ exp.toGMTString();
    &#125;
  &#125;)
&#125;</code></pre><p>建议把js代码放在valine的初始化代码后面，没必要放body里，记得把云引擎地址改成自己的。valine-admin配置里的ADMIN_URL就是云引擎地址。</p><p>valine-admin没有允许跨域请求（确实没必要），但是使用ajax请求唤醒云引擎会导致浏览器控制台报错（能成功唤醒，我不能忍受错误信息）。</p><p>顺便改了下valine-admin，<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/track23/Valine-Admin">valine-admin</a> 这是我改过的版本，我fork的是<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/DesertsP/Valine-Admin">DesertsP</a>写的valine-admin。还有一个版本是<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/zhaojun1998/Valine-Admin">zhaojun</a>的，2个valine-admin好像云引擎的配置信息不一样，请注意区分。</p><p>使用zhaojun版本的valine-admin的可以自行修改。（对着我的提交记录改就可以了，那部分文件内容是一样的）。</p><h2 id="各种方法的选择"><a href="#各种方法的选择" class="headerlink" title="各种方法的选择"></a>各种方法的选择</h2><p>除了上面提到的使用github action，还有各种监控都能用来唤醒云引擎。</p><p>ajax请求唤醒适合佛系一点的人，访客多就把时间设置在早上8-9点，后面的时间由云引擎的定时任务唤醒。访客少就建议把云引擎的定时任务关了。博客没什么人访问，那么云引擎可能一天都不会醒几次。像我这种贪心的人，即使博客没人访问也想要云引擎醒着。</p><p>github action的定时任务每次执行都会提交一次。为了方便查看云引擎状况同时不想看见那么多commit。我把action定时任务的cron表达式改成了<code>50 23 * * *</code>，每天早上7点50执行一次，之后由云引擎自己唤醒。一个月大概会出现2-3次唤醒失败，还能接受。</p><p>最后再推荐一波waline。自带后端就不再依赖云引擎了。</p><div class="license"><p class="license-title">解决valine-admin云引擎唤醒失败</p><p class="license-link"><a href="https://crosschannel.cc/daily/valine-admin-autoAwaken.html">https://crosschannel.cc/daily/valine-admin-autoAwaken.html</a></p><div class="license-meta"><div class="license-meta-item"><div>本文作者</div><div>Track13</div></div><div class="license-meta-item"><div>发布于</div><div>2020-05-15</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a></div></div></div><p class="license-info">转载或引用本文时请遵守许可协议，注明出处、不得用于商业用途！</p><div class="iconfont iconcc_licenses"></div></div></div><footer id="posts-footer"> <span class="iconfont iconrili"><a href="" rel="bookmark"><time class="updated" datetime="2020-05-15T09:23:00.000Z">2020-05-15</time></a></span> <span class="iconfont iconwenjianjia"><a href="/categories/%E6%97%A5%E5%B8%B8/" rel="category tag">日常</a></span> <span class="iconfont iconbiaoqian"><a href="/tags/Hexo/" rel="category tag">Hexo</a></span><span class="iconfont iconeye"><span id="/daily/valine-admin-autoAwaken.html" class="leancloud_visitors" data-flag-title="解决valine-admin云引擎唤醒失败"></span></span></footer></article><div id="comment"><p id="comments-title">《解决valine-admin云引擎唤醒失败》上有<span id="comment-count"></span>条评论</p><div id="valine"></div><script>"function"==typeof loadValine&&loadValine()</script></div><nav id="post-navigation" role="navigation"> <a id="nav-prev" href="/gal/BishoujoMangekyou.html"><span>上一篇</span> <span class="link-title">简谈美少女万华镜</span></a> <a id="nav-next" href="/animation/hello-world.html"><span>下一篇</span> <span class="link-title">HELLO-WORLD</span></a></nav></main><footer id="footer"> powered by <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io/">Hexo</a> theme by <a href="/">Track13</a> inspired by <a target="_blank" rel="noopener external nofollow noreferrer" href="https://wordpress.org/themes/twentyfifteen/">wordpress</a></footer><div id="back-top"><a href="#main"><i class="iconfont icontoparr"></i></a></div><div id="landlord" style="display:none;contain:layout"><div class="message" style="opacity:0"></div><canvas id="live2d" width="800" height="800" class="live2d"></canvas></div> <button id="xm"></button></body></html>