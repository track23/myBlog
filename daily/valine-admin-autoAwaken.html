<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,minimal-ui"><meta name="format-detection" content="telephone=no"><meta name="author" content="Track13,1262914934@qq.com"><meta name="apple-mobile-web-app-title" content="宅日记"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta http-equiv="x-dns-prefetch-control" content="on"><meta name="keywords" content="valine-admin"><meta name="description " content="解决valine-admin云引擎自动唤醒唤醒失败"><meta content="#fff" name="theme-color"><link href="https://crosschannel.cc/" rel="canonical"><link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"><link rel="shortcut icon" type="image/ico" href="/favicon.ico"><title>解决valine-admin云引擎唤醒失败 | 宅日记</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/track23/blog-static/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><link rel="dns-prefetch" href="https://gravatar.loli.net"><meta name="generator" content="Hexo 5.2.0"></head><body><script>var metaNode=document.querySelector('meta[name="theme-color"]');"1"===localStorage.getItem("dark")?(document.body.classList.add("dark"),metaNode.setAttribute("content","#282c34")):21<=(new Date).getHours()||(new Date).getHours()<7?(document.body.classList.add("dark"),metaNode.setAttribute("content","#282c34")):matchMedia("(prefers-color-scheme: dark)").matches&&(document.body.classList.add("dark"),metaNode.setAttribute("content","#282c34"))</script><div class="loading-bar"><div class="progress"></div></div><div id="site" class="site"><div id="sidebar" class="sidebar"><header id="header" class="site-header"><div class="site-branding"><h1 class="site-title"> <a href="/" rel="home">宅日记</a></h1><p class="site-description">一个不知名懒肥宅的自留地</p> <button class="secondary-toggle icon-menu">Menu and widgets</button></div></header><div id="secondary" class="secondary"><nav class="main-navigation"><ul id="menu-demo-menu" class="nav-menu"><li class="menu-item"><a href="/categories/gal/">galgame</a></li><li class="menu-item"><a href="/categories/%E5%8A%A8%E7%94%BB/">动画</a></li><li class="menu-item"><a href="/categories/%E6%97%A5%E5%B8%B8/">日常</a></li><li class="menu-item"><a href="/aboutme.html">关于</a></li><li class="menu-item"><a href="/links.html">友链</a></li></ul></nav><div class="header-music"><meting-js id="2382854733" server="netease" type="playlist" order="random" volume="0.3" preload="none" list-max-height="200px" list-folded="true" lrc-type="false" theme="#00b9f1"></meting-js></div><aside class="widget"><form id="search-form" method="get" action="/search.html"> <input id="local-search-input" type="search" class="search-field" placeholder="Search …" value="" name="s"></form></aside><aside class="widget"><h3 class="widget-title">标签云</h3><div id="tags-cloud"><a href="/tags/Hexo/" style="font-size:16.67px">Hexo</a> <a href="/tags/%E4%BA%BA%E7%B1%BB%E5%9C%A3%E7%BB%8F/" style="font-size:10px">人类圣经</a> <a href="/tags/%E5%85%A8%E5%B9%B4%E9%BE%84/" style="font-size:20px">全年龄</a> <a href="/tags/%E5%9E%8B%E6%9C%88/" style="font-size:10px">型月</a> <a href="/tags/%E5%A5%88%E9%A1%BB%E8%98%91%E8%8F%87/" style="font-size:10px">奈须蘑菇</a> <a href="/tags/%E6%B2%BB%E6%84%88/" style="font-size:11.67px">治愈</a> <a href="/tags/%E6%BF%91%E6%88%B7%E5%8F%A3%E5%BB%89%E4%B9%9F/" style="font-size:16.67px">濑户口廉也</a> <a href="/tags/%E7%94%B0%E4%B8%AD%E7%BD%97%E5%AF%86%E6%AC%A7/" style="font-size:18.33px">田中罗密欧</a> <a href="/tags/%E7%A5%9E%E4%BD%9C/" style="font-size:15px">神作</a> <a href="/tags/%E7%BE%BD%E6%B5%B7%E9%87%8E%E5%8D%83%E8%8A%B1/" style="font-size:13.33px">羽海野千花</a> <a href="/tags/%E8%87%B4%E9%83%81/" style="font-size:16.67px">致郁</a> <a href="/tags/%E9%83%BD%E5%90%88%E4%B8%BB%E4%B9%89/" style="font-size:10px">都合主义</a></div></aside></div></div><div id="content" class="site-content"><main id="main" class="site-main" role="main"><script defer="defer" src="https://zz.bdstatic.com/linksubmit/push.js"></script><article class="hentry"><header class="entry-header"><h2 class="entry-title"><a class="post-title-link" href="/daily/valine-admin-autoAwaken.html" rel="bookmark">解决valine-admin云引擎唤醒失败</a></h2></header><div class="entry-content"><p>4月就收到了leancloud要限制白嫖用户定时任务的邮件。一直没有太在意。昨天晚上打开leanclou的日志，云引擎已经休眠好几天了。</p><a id="more"></a><blockquote><p>因流控原因，通过定时任务唤醒体验版实例失败，建议升级至标准版云引擎实例避免休眠</p></blockquote><p>使用云引擎自带定时任务以前都是大佬使用vps定时访问云引擎避免自动休眠，但是我没有vps，也找不到大佬，只能从js下手了。</p><p>能唤醒云引擎的方法除了发请求还有就是有人写评论（这条评论不会收到邮件提醒）。唤醒过一次之后，云引擎的定时任务能正常执行。</p><p>除了js发请求唤醒，我还看到有使用github action来唤醒的，这种方法挺好的（我之前没想到）推荐大家使用。</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.antmoe.com/posts/ff6aef7b/index.html">使用github action解决流控问题</a></p><h2 id="ajax请求唤醒"><a href="#ajax请求唤醒" class="headerlink" title="ajax请求唤醒"></a>ajax请求唤醒</h2><p>思路就是北京时间8点到晚上23点只要有人访问博客就会触发js发ajax请求唤醒云引擎。由于云引擎睡眠的时候发请求不一定会成功（但是有请求就会醒）所有没有做请求失败处理。请求发送后设置cookie避免20分钟内刷新等操作重复发请求。</p><p>虽然博客使用了jQuery，但是我选择fetch，兼容性也凑合（不行就算了）。迟早要把jQuery从博客去掉。</p><p>只认北京时间，避免半夜其他时区打开而唤醒云引擎。北京时间的api是苏宁的。</p><p>cookie中的engine,默认是’0’ ，’1’代表发送过请求。cookie过期时间20分钟，避免刷新等操作重复发请求。</p><p>以下代码没有注释是因为写了注释就导致valine初始化失败。不知道原因QAQ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> engine = <span class="built_in">document</span>.cookie.replace(<span class="regexp">/(?:(?:^|.*;\s*)engine\s*\=\s*([^;]*).*$)|^.*$/</span>, <span class="string">&quot;$1&quot;</span>) || <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(engine!=<span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">  fetch(<span class="string">&#x27;https://quan.suning.com/getSysTime.do&#x27;</span>)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> response.json();</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">date</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hours = <span class="keyword">new</span> <span class="built_in">Date</span>(date.sysTime2).getHours();</span><br><span class="line">    <span class="keyword">if</span>(hours&gt;<span class="number">7</span> &amp;&amp; hours&lt;<span class="number">23</span>)&#123;</span><br><span class="line">      fetch(<span class="string">&#x27;https://你云引擎的地址&#x27;</span>);</span><br><span class="line">      <span class="keyword">var</span> exp = <span class="keyword">new</span> <span class="built_in">Date</span>(date.sysTime2);</span><br><span class="line">      exp.setTime(exp.getTime() + <span class="number">20</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">      <span class="built_in">document</span>.cookie = <span class="string">&quot;engine=1;path=/;expires=&quot;</span>+ exp.toGMTString();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>建议把js代码放在valine的初始化代码后面，没必要放body里，记得把云引擎地址改成自己的。valine-admin配置里的ADMIN_URL就是云引擎地址。</p><p>valine-admin没有允许跨域请求（确实没必要），但是使用ajax请求唤醒云引擎会导致浏览器控制台报错（能成功唤醒，我不能忍受错误信息）。</p><p>顺便改了下valine-admin，<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/track23/Valine-Admin">valine-admin</a> 这是我改过的版本，我fork的是<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/DesertsP/Valine-Admin">DesertsP</a>写的valine-admin。还有一个版本是<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/zhaojun1998/Valine-Admin">zhaojun</a>的，2个valine-admin好像云引擎的配置信息不一样，请注意区分。</p><p>使用zhaojun版本的valine-admin的可以自行修改。（对着我的提交记录改就可以了，那部分文件内容是一样的）。</p><h2 id="各种方法的选择"><a href="#各种方法的选择" class="headerlink" title="各种方法的选择"></a>各种方法的选择</h2><p>除了上面提到的使用github action，还有各种监控都能用来唤醒云引擎。</p><p>我现在使用的是github action这种。偶尔回唤醒失败。</p><p>ajax请求唤醒适合佛系一点的人，访客多就把时间设置在早上8-9点，后面的时间由云引擎的定时任务唤醒。访客少就建议把云引擎的定时任务关了。博客没什么人访问，那么云引擎可能一天都不会醒几次。像我这种贪心的人，即使博客没人访问也想要云引擎醒着。</p><p>github action的定时任务每次执行都会提交一次。为了方便查看云引擎状况同时不想看见那么多commit。我把action定时任务的cron表达式改成了<code>50 23 * * *</code>，每天早上7点50执行一次，之后由云引擎自己唤醒。</p></div><div class="entry-comments"><div class="comment"></div><script>var entry=document.getElementsByClassName("entry-comments")[0];function loadValine(){var n=document.createElement("script");n.type="text/javascript",n.onload=n.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(ldcallBack(),n.onload=n.onreadystatechange=null)},n.src="https://cdn.jsdelivr.net/gh/track23/blog-static/Valine.min.js",entry.appendChild(n)}function ldcallBack(){new Valine({el:".comment",lang:"zh-cn",emoticon_url:"https://cdn.jsdelivr.net/gh/track23/blog-static/alu",emoticon_list:["吐.png","喷血.png","狂汗.png","不说话.png","汗.png","坐等.png","献花.png","不高兴.png","中刀.png","害羞.png","皱眉.png","小眼睛.png","中指.png","尴尬.png","瞅你.png","想一想.png","中枪.png","得意.png","肿包.png","扇耳光.png","亲亲.png","惊喜.png","脸红.png","无所谓.png","便便.png","愤怒.png","蜡烛.png","献黄瓜.png","内伤.png","投降.png","观察.png","看不见.png","击掌.png","抠鼻.png","邪恶.png","看热闹.png","口水.png","抽烟.png","锁眉.png","装大款.png","吐舌.png","无奈.png","长草.png","赞一个.png","呲牙.png","无语.png","阴暗.png","不出所料.png","咽气.png","期待.png","高兴.png","吐血倒地.png","哭泣.png","欢呼.png","黑线.png","喜极而泣.png","喷水.png","深思.png","鼓掌.png","暗地观察.png"],app_id:"UqKcJNE0cBerSu52yLvC1qVs-gzGzoHsz",app_key:"cUR3tOdrBA0ULbONb8sfOipw",placeholder:"Write a Comment",admin_email_hash:"ed69c6079398441b73dbfdbbfc8cd196",max_nest:2,page_size:5})}var runningOnBrowser="undefined"!=typeof window,isBot=runningOnBrowser&&!("onscroll"in window)||"undefined"!=typeof navigator&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent),supportsIntersectionObserver=runningOnBrowser&&"IntersectionObserver"in window;setTimeout(function(){if(!isBot&&supportsIntersectionObserver){var e=new IntersectionObserver(function(n){n[0].isIntersecting&&(loadValine(),e.disconnect())},{threshold:[0]});e.observe(entry)}else loadValine()},1)</script></div><footer class="entry-footer"> <span class="icon-calendar"><a href="" rel="bookmark"><time class="updated" datetime="2020-05-15T09:23:00.000Z">2020-05-15</time></a></span> <span class="icon-folder"><a href="/categories/%E6%97%A5%E5%B8%B8/" rel="category tag">日常</a></span> <span class="icon-tags"><a href="/tags/Hexo/" rel="category tag">Hexo</a></span><span class="icon-eye"><span id="/daily/valine-admin-autoAwaken.html" class="leancloud_visitors" data-flag-title="解决valine-admin云引擎唤醒失败"></span></span></footer></article></main></div><footer id="colophon" class="site-footer"><div class="site-info"> <span>powered by <a href="https://hexo.io/" rel="external nofollow noreferrer" target="_blank">Hexo</a>&nbsp;&nbsp; theme by <a href="https://github.com/Troy-Yang/hexo-theme-twentyfifteen-wordpress" rel="external nofollow noreferrer" target="_blank">Troy</a> &nbsp; inspired by <a href="https://wordpress.org/themes/" rel="external nofollow noreferrer" target="_blank">wordpress</a></span></div><div class="xm" role="button">暗色模式开关</div><div id="landlord"><div class="message" style="opacity:0"></div><canvas id="live2d" width="220" height="340" class="live2d"></canvas></div><div class="misc"> <a href="#main"><span class="icon-angle-circled-up">Top</span></a></div></footer></div><script async pjax-reload src="https://hm.baidu.com/hm.js?6e7c5cd833e842d7c53b95ef61c1c5a5"></script><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script defer="defer" src="/js/track13.min.js"></script><script>window.imageLazyLoadSetting={isSPA:!1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(n){n.imageLazyLoadSetting.processImages=i;var e=n.imageLazyLoadSetting.isSPA,l=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){e&&(l=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var r=0;r<l.length;r++)0<=(t=l[r].getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight||document.documentElement.clientHeight)&&function(t){var e,n,i,o,a=l[r];e=a,n=function(){l=l.filter(function(t){return a!==t})},i=new Image,o=e.getAttribute("data-original"),i.onload=function(){e.src=o,n()},i.src=o}();var t}i(),n.addEventListener("scroll",function(){var t,e;t=i,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html>